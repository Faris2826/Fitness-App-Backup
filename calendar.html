<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calendar - Rehma Health OS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF69B4">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            /* Light Theme */
            --bg-body: #FFF0F5;
            --bg-card: #FFFFFF;
            --text-main: #2D3748;
            --text-sub: #718096;
            --primary: #FF69B4;
            --primary-soft: #FFB6C1;
            --primary-dim: rgba(255, 105, 180, 0.1);
            
            --border: #F7FAFC;
            --input-bg: #F7FAFC;
            --shadow-card: 0 8px 24px rgba(255, 105, 180, 0.08);
            --radius-l: 28px;
            --radius-m: 20px;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-body: #121212;
            --bg-card: #1E1E1E;
            --text-main: #F7FAFC;
            --text-sub: #A0AEC0;
            --primary: #FF69B4;
            --primary-soft: #D53F8C;
            --primary-dim: rgba(255, 105, 180, 0.2);
            
            --border: #2D3748;
            --input-bg: #2D3748;
            --shadow-card: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 120px;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* HEADER */
        .header { padding: 40px 24px 20px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--primary); margin: 0; font-weight: 800; }

        .container { padding: 0 20px; max-width: 600px; margin: 0 auto; }

        /* CALENDAR CARD */
        .cal-card {
            background: var(--bg-card);
            border-radius: var(--radius-l);
            padding: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
        }

        .cal-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .month-display { font-family: 'Playfair Display'; font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
        .nav-btn {
            background: var(--input-bg); border: none; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); font-size: 1.2rem;
            transition: 0.2s;
        }
        .nav-btn:active { transform: scale(0.9); background: var(--primary); color: white; }

        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 16px; font-size: 0.95rem; position: relative; cursor: pointer;
            background: transparent; transition: 0.2s; border: 2px solid transparent; font-weight: 500;
        }
        .day:hover { background: var(--input-bg); }
        .day.today { border-color: var(--primary); color: var(--primary); font-weight: 700; }
        .day.selected { background: var(--primary); color: white !important; box-shadow: 0 4px 12px var(--primary-dim); border-color: transparent; }

        /* DOT INDICATORS */
        .dots-row { display: flex; gap: 4px; margin-top: 4px; height: 4px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot.cycle { background-color: #E91E63; }
        .dot.food { background-color: #48BB78; }

        /* BOTTOM SHEET (Modal) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 1000;
            backdrop-filter: blur(4px);
            display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .sheet {
            background: var(--bg-card); width: 100%; max-width: 600px; margin: 0 auto;
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            padding: 32px 24px 40px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.active .sheet { transform: translateY(0); }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .sheet-title { font-family: 'Playfair Display'; font-size: 1.5rem; font-weight: 700; }
        .close-btn { background: var(--input-bg); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; color: var(--text-sub); }

        /* ACTIONS */
        .section-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); font-weight: 700; margin-bottom: 12px; margin-top: 24px; }
        .section-label:first-child { margin-top: 0; }

        .cycle-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-btn {
            padding: 16px; border-radius: var(--radius-m); border: 2px solid var(--border);
            background: var(--bg-card); color: var(--text-main); font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.96); }
        .action-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }

        /* FOOD LIST */
        .log-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--input-bg); border-radius: 16px;
        }
        .log-name { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .log-meta { font-size: 0.8rem; color: var(--text-sub); margin-top: 2px; }
        .log-del { background: none; border: none; color: #E53E3E; opacity: 0.6; cursor: pointer; padding: 8px; }

        /* TABS (Food Creator) */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--input-bg); padding: 4px; border-radius: 16px; }
        .tab {
            flex: 1; padding: 10px; text-align: center; border-radius: 12px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; color: var(--text-sub); transition: 0.2s;
        }
        .tab.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* FORM INPUTS */
        .form-grid { display: grid; gap: 16px; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; }
        .app-input {
            width: 100%; padding: 14px; background: var(--input-bg); border: 2px solid transparent;
            border-radius: 16px; font-size: 1rem; color: var(--text-main); outline: none; transition: 0.2s;
        }
        .app-input:focus { border-color: var(--primary); background: var(--bg-card); }
        
        .macro-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

        /* NAV */
        .nav-bar {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px);
            border-radius: 32px; padding: 16px 32px;
            display: flex; justify-content: space-between;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); z-index: 100;
        }
        [data-theme="dark"] .nav-bar { background: rgba(30, 30, 30, 0.9); border: 1px solid rgba(255,255,255,0.05); }
        .nav-item { text-decoration: none; font-size: 1.6rem; color: var(--text-sub); opacity: 0.6; transition: 0.3s; }
        .nav-item.active { color: var(--primary); opacity: 1; transform: translateY(-4px); }

    </style>
</head>
<body>

    <header class="header">
        <h1>Calendar</h1>
    </header>

    <div class="container">
        <div class="cal-card">
            <div class="cal-controls">
                <button class="nav-btn" onclick="shiftMonth(-1)">‚Äπ</button>
                <div class="month-display" id="month-label">December 2025</div>
                <button class="nav-btn" onclick="shiftMonth(1)">‚Ä∫</button>
            </div>

            <div class="weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            
            <div class="days-grid" id="calendar-grid">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="day-sheet">
        <div class="sheet">
            <div class="sheet-header">
                <h2 class="sheet-title" id="sheet-date-title">Date</h2>
                <button class="close-btn" onclick="closeSheet('day-sheet')">√ó</button>
            </div>

            <div class="section-label">Cycle Control</div>
            <div class="cycle-actions">
                <button class="action-btn" onclick="logCycle('start')">ü©∏ Period Start</button>
                <button class="action-btn" onclick="logCycle('end')">üèÅ Period End</button>
            </div>

            <div class="section-label">Nutrition Log</div>
            <div id="day-food-list" class="log-list">
                </div>
            
            <button class="action-btn primary" style="width:100%" onclick="openFoodCreator()">
                <span>+ Log Food</span>
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="food-sheet">
        <div class="sheet">
            <div class="sheet-header">
                <h2 class="sheet-title">Log Nutrition</h2>
                <button class="close-btn" onclick="closeSheet('food-sheet')">√ó</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('library')" id="tab-btn-lib">Library</div>
                <div class="tab" onclick="switchTab('create')" id="tab-btn-new">Create New</div>
            </div>

            <div id="view-library">
                <input type="text" class="app-input" placeholder="Search saved foods..." id="lib-search" onkeyup="renderLibrary()">
                <div class="log-list" id="lib-list" style="margin-top:16px; max-height:300px; overflow-y:auto;">
                    </div>
            </div>

            <div id="view-create" style="display:none;" class="form-grid">
                <div class="input-group">
                    <label>Food Name</label>
                    <input type="text" id="new-name" class="app-input" placeholder="e.g. Mom's Pasta">
                </div>
                
                <div class="input-group">
                    <label>Calories</label>
                    <input type="number" id="new-cals" class="app-input" placeholder="kcal">
                </div>

                <div class="macro-row">
                    <div class="input-group">
                        <label>Prot</label>
                        <input type="number" id="new-p" class="app-input">
                    </div>
                    <div class="input-group">
                        <label>Carb</label>
                        <input type="number" id="new-c" class="app-input">
                    </div>
                    <div class="input-group">
                        <label>Fat</label>
                        <input type="number" id="new-f" class="app-input">
                    </div>
                    <div class="input-group">
                        <label>Fiber</label>
                        <input type="number" id="new-fiber" class="app-input">
                    </div>
                </div>

                <button class="action-btn primary" onclick="saveNewFood()">Save & Log</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="index.html" class="nav-item">üè†</a>
        <a href="calendar.html" class="nav-item active">üìÖ</a>
        <a href="workouts.html" class="nav-item">üßò‚Äç‚ôÄÔ∏è</a>
        <a href="progress.html" class="nav-item">üìä</a>
        <a href="analytics.html" class="nav-item">üìà</a>
    </nav>

    <script src="main.js"></script>
    <script>
        // === CALENDAR LOGIC ===

        let viewDate = new Date();
        let selectedDateKey = new Date().toISOString().split('T')[0];

        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
            
            // Listen for data changes to auto-refresh dots
            window.addEventListener('rehma_update', (e) => {
                applyTheme(e.detail.theme);
                renderCalendar(); 
                if(document.getElementById('day-sheet').classList.contains('active')) {
                    openDaySheet(selectedDateKey); // Refresh list
                }
            });

            // Initial Theme
            if(window.healthOS) applyTheme(window.healthOS.state.settings.theme);
        });

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            // Update Label
            document.getElementById('month-label').textContent = 
                viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            // Access Brain Data
            const logs = window.healthOS ? window.healthOS.state.logs : { nutrition: {} };
            const cycles = window.healthOS ? window.healthOS.state.cycle.events : [];

            // Padding Days
            for(let i=0; i<firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }

            // Days
            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const el = document.createElement('button');
                el.className = `day ${dateKey === todayStr ? 'today' : ''}`;
                if(dateKey === selectedDateKey && document.querySelector('.modal-overlay.active')) {
                    el.classList.add('selected');
                }
                
                el.innerHTML = `<span>${d}</span>`;
                
                // Dots container
                const dots = document.createElement('div');
                dots.className = 'dots-row';

                // Check Data for Dots
                // 1. Cycle Dot
                const isCycleEvent = cycles.some(e => e.date === dateKey);
                if(isCycleEvent) dots.innerHTML += `<div class="dot cycle"></div>`;

                // 2. Food Dot
                if(logs.nutrition[dateKey] && logs.nutrition[dateKey].length > 0) {
                    dots.innerHTML += `<div class="dot food"></div>`;
                }

                el.appendChild(dots);
                el.onclick = () => openDaySheet(dateKey);
                grid.appendChild(el);
            }
        }

        function shiftMonth(delta) {
            viewDate.setMonth(viewDate.getMonth() + delta);
            renderCalendar();
        }

        // === DAY SHEET LOGIC ===

        function openDaySheet(dateStr) {
            selectedDateKey = dateStr;
            const displayDate = new Date(dateStr + 'T00:00:00'); // Force local time
            document.getElementById('sheet-date-title').textContent = displayDate.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
            
            renderFoodLog(dateStr);
            
            document.getElementById('day-sheet').classList.add('active');
            renderCalendar(); // Update selection highlight
        }

        function closeSheet(id) {
            document.getElementById(id).classList.remove('active');
            if(id === 'food-sheet') document.getElementById('day-sheet').classList.add('active'); // Re-show day sheet
            renderCalendar();
        }

        // Cycle Actions
        function logCycle(type) {
            if(confirm(`Log Period ${type.toUpperCase()} on this day?`)) {
                if(type === 'start') window.healthOS.logPeriodStart(selectedDateKey);
                else window.healthOS.logPeriodEnd(selectedDateKey);
            }
        }

        // Nutrition List
        function renderFoodLog(dateStr) {
            const list = document.getElementById('day-food-list');
            list.innerHTML = '';
            
            if(!window.healthOS) return;
            const foods = window.healthOS.state.logs.nutrition[dateStr] || [];

            if(foods.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:var(--text-sub); padding:10px;">No logs yet.</div>`;
                return;
            }

            foods.forEach(f => {
                list.innerHTML += `
                <div class="log-item">
                    <div>
                        <div class="log-name">${f.name}</div>
                        <div class="log-meta">${f.cals} kcal ‚Ä¢ P:${f.p} C:${f.c} F:${f.f}</div>
                    </div>
                    <button class="log-del" onclick="removeFood('${f.id}')">Remove</button>
                </div>`;
            });
        }

        function removeFood(id) {
            window.healthOS.removeFood(selectedDateKey, parseInt(id));
            openDaySheet(selectedDateKey); // Refresh
        }

        // === FOOD CREATOR LOGIC ===

        function openFoodCreator() {
            document.getElementById('day-sheet').classList.remove('active');
            document.getElementById('food-sheet').classList.add('active');
            switchTab('library');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(tab === 'library') {
                document.getElementById('tab-btn-lib').classList.add('active');
                document.getElementById('view-library').style.display = 'block';
                document.getElementById('view-create').style.display = 'none';
                renderLibrary();
            } else {
                document.getElementById('tab-btn-new').classList.add('active');
                document.getElementById('view-library').style.display = 'none';
                document.getElementById('view-create').style.display = 'grid';
            }
        }

        function renderLibrary() {
            const query = document.getElementById('lib-search').value.toLowerCase();
            const container = document.getElementById('lib-list');
            container.innerHTML = '';

            if(!window.healthOS) return;
            const library = window.healthOS.state.library;

            const filtered = library.filter(f => f.name.toLowerCase().includes(query));

            filtered.forEach(f => {
                const el = document.createElement('div');
                el.className = 'log-item';
                el.style.cursor = 'pointer';
                el.onclick = () => {
                    window.healthOS.logFood(selectedDateKey, f);
                    closeSheet('food-sheet');
                };
                el.innerHTML = `
                    <div>
                        <div class="log-name">${f.name}</div>
                        <div class="log-meta">${f.cals} kcal</div>
                    </div>
                    <div style="font-size:1.2rem; color:var(--primary);">+</div>
                `;
                container.appendChild(el);
            });
        }

        function saveNewFood() {
            const name = document.getElementById('new-name').value;
            if(!name) return alert("Please name your food");

            const food = {
                name: name,
                cals: document.getElementById('new-cals').value || 0,
                p: document.getElementById('new-p').value || 0,
                c: document.getElementById('new-c').value || 0,
                f: document.getElementById('new-f').value || 0,
                fiber: document.getElementById('new-fiber').value || 0
            };

            window.healthOS.logFood(selectedDateKey, food);
            
            // Clear Form
            document.getElementById('new-name').value = '';
            document.getElementById('new-cals').value = '';
            
            closeSheet('food-sheet');
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
        }

    </script>
</body>
</html>